name: üöÄ Deploy Frontend Vue 3 + Bootstrap 5

# D√©clenche le workflow uniquement sur les pushes sur la branche main
on:
  push:
    branches:
      - main

jobs:
  deploy_frontend:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ R√©cup√©rer le code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Installer Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      # 3Ô∏è‚É£ Installer les d√©pendances frontend
      - name: Install frontend dependencies
        run: |
          npm ci

      # 4Ô∏è‚É£ Construire le frontend
      - name: Build frontend
        run: |
          npm run build

      # 4Ô∏è‚É£ bis ‚Äì Cr√©er le .htaccess pour SPA
      - name: Create .htaccess for SPA routing
        run: |
          cat <<EOT > dist/.htaccess
          # Activer la r√©√©criture d'URL
          RewriteEngine On

          # Si la requ√™te correspond √† un fichier ou un r√©pertoire existant, Apache ne r√©√©crit pas l'URL
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d

          # R√©√©crire toutes les requ√™tes vers index.html pour g√©rer la SPA (Single Page Application)
          RewriteRule ^ index.html [QSA,L]

          # Redirection HTTP vers HTTPS (optionnel)
          # Si ton site utilise HTTPS, d√©commente cette section pour forcer la redirection vers HTTPS
          # RewriteCond %{HTTPS} off
          # RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

          # Cache des fichiers statiques pour am√©liorer la performance
          <FilesMatch "\.(jpg|jpeg|png|gif|css|js|woff|woff2|ttf|eot|svg|otf)$">
          Header set Cache-Control "public, max-age=31536000, immutable"
          </FilesMatch>

          # G√©rer la s√©curit√© en limitant l'acc√®s √† certains fichiers
          <FilesMatch "\.(htaccess|htpasswd|ini|log|sh|git)">
          Order Allow,Deny
          Deny from all
          </FilesMatch>

          # S√©curiser les en-t√™tes HTTP (optionnel mais recommand√©)
          Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
          Header always set X-Content-Type-Options "nosniff"
          Header always set X-Frame-Options "SAMEORIGIN"
          Header always set X-XSS-Protection "1; mode=block"
          Header always set Referrer-Policy "strict-origin-when-cross-origin"

          # Pr√©venir les attaques de type clickjacking
          Header always set X-Frame-Options "DENY"

          # php -- BEGIN cPanel-generated handler, do not edit
          # Set the ‚Äúea-php81‚Äù package as the default ‚ÄúPHP‚Äù programming language.
          <IfModule mime_module>
            AddHandler application/x-httpd-ea-php81 .php .php8 .phtml
          </IfModule>
          # php -- END cPanel-generated handler, do not edit

          EOT

      # 5Ô∏è‚É£ D√©ployer sur cPanel via SFTP
      - name: Deploy Frontend via SFTP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.FTP_HOST }}          # ton serveur cPanel
          username: ${{ secrets.FTP_USERNAME }}
          key: ${{ secrets.SFTP_PRIVATE_KEY }}   # cl√© SSH pour le serveur
          port: ${{ secrets.SFTP_PORT }}         # souvent 22 ou ton port personnalis√©
          source: "dist/*"             # dossier g√©n√©r√© par npm run build
          target: "/home/axproo/public_html/vue_dashboard"   # dossier cible sur le serveur
          rm: false                              # supprime les anciens fichiers
          overwrite: true                        # √©crase uniquement les fichiers modifi√©s
          debug: true                            # logs d√©taill√©s pour le d√©bogage
